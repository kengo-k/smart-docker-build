name: 'Smart Docker Build'
description: 'Intelligently build and push Docker images with multi-platform support, change detection, and flexible tagging strategies. Supports GHCR and DockerHub with automatic validation and error handling.'
author: 'kengo-k'
branding:
  icon: 'package'
  color: 'blue'
inputs:
  token:
    description: 'GitHub Token with permissions to access repository information and push images to container registry (GHCR_TOKEN or DOCKERHUB_TOKEN)'
    required: true
  timezone:
    description: 'Timezone for generating timestamps in image tags (e.g., "UTC", "Asia/Tokyo", "America/New_York")'
    required: false
    default: 'UTC'
runs:
  using: 'composite'
  steps:
    - name: 'Get docker build args'
      id: js_action
      run: |
        cd ${{ github.action_path }}/internal/get
        npm ci
        npm run build
        node dist/index.js
      shell: bash
      env:
        INPUT_TOKEN: ${{ inputs.token }}      # â† ã“ã“ã§ inputs.token ã‚’ INPUT_TOKEN ã«å¤‰æ›
        INPUT_TIMEZONE: ${{ inputs.timezone }} # â† ã“ã“ã§ inputs.timezone ã‚’ INPUT_TIMEZONE ã«å¤‰æ›

    - name: Login to ghcr
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ inputs.token }}

    - name: Checkout latest commit
      uses: actions/checkout@v4

    - name: 'Build and Push Docker Images'
      shell: bash
      run: |
        build_args='${{ steps.js_action.outputs.build_args }}'
        echo "ğŸ”§ Starting Docker build and push process..."
        echo "ğŸ“‹ Build args JSON: $build_args"

        # Debug: show each element
        echo "ğŸ“‹ Individual elements:"
        echo "$build_args" | jq -c '.[]' | while read -r element; do
          echo "  - $element"
        done

        success_count=0
        failure_count=0
        
        # Get array length
        length=$(echo "$build_args" | jq '. | length')
        echo "ğŸ“Š Total items to process: $length"
        
        # Process each element by index to avoid subshell issues
        for ((i=0; i<length; i++)); do
          element=$(echo "$build_args" | jq -c ".[$i]")
          echo "ğŸ”„ Processing element $((i+1))/$length: $element"
          
          path=$(echo "$element" | jq -r '.path')
          name=$(echo "$element" | jq -r '.name')
          tag=$(echo "$element" | jq -r '.tag')

          echo "ğŸ“¦ Building image: $name:$tag from $path"
          echo "ğŸ” Extracted values: path=$path, name=$name, tag=$tag"

          # Build the Docker image
          echo "ğŸ—ï¸ Starting Docker build..."
          if docker build -t ghcr.io/${{ github.actor }}/$name:$tag -f $path $(dirname $path); then
            echo "âœ… Successfully built ghcr.io/${{ github.actor }}/$name:$tag"

            # Push the Docker image
            echo "ğŸ“¤ Starting Docker push..."
            if docker push ghcr.io/${{ github.actor }}/$name:$tag; then
              echo "âœ… Successfully pushed ghcr.io/${{ github.actor }}/$name:$tag"
              success_count=$((success_count + 1))
            else
              echo "âŒ Failed to push ghcr.io/${{ github.actor }}/$name:$tag"
              failure_count=$((failure_count + 1))
            fi
          else
            echo "âŒ Failed to build ghcr.io/${{ github.actor }}/$name:$tag from $path"
            echo "ğŸ’¡ Please check:"
            echo "   - Dockerfile syntax in $path"
            echo "   - Base image availability"
            echo "   - Build context in $(dirname $path)"
            ((failure_count++))
          fi
          
          echo "ğŸ”„ Completed processing for $name:$tag (item $((i+1))/$length)"
          echo "---"
        done

        echo "ğŸ“Š Build Summary:"
        echo "   âœ… Successful: $success_count"
        echo "   âŒ Failed: $failure_count"

        if [ $failure_count -gt 0 ] && [ $success_count -eq 0 ]; then
          echo "ğŸ’¥ All builds failed. Please check the errors above."
          exit 1
        elif [ $failure_count -gt 0 ]; then
          echo "âš ï¸  Some builds failed, but continuing with successful ones."
        else
          echo "ğŸ‰ All builds completed successfully!"
        fi
